services:
  db:
    image: postgres:17
    container_name: {devports:project}-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: social_tracker
    ports:
      - "{devports:postgres:db}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  webapp:
    build:
      context: .
      dockerfile: Dockerfile.webapp
      args:
        NODE_ENV: development
    container_name: {devports:project}-webapp
    environment:
      # Database (uses docker network, not localhost)
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/social_tracker
      # Auth.js
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_URL=${AUTH_URL}
      # Encryption key for API key storage
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      # Groq API key for AI suggestions
      - GROQ_API_KEY=${GROQ_API_KEY}
      # App URL
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      # Tailscale
      - TAILSCALE_AUTHKEY=${TAILSCALE_AUTHKEY}
      - TAILSCALE_HOSTNAME=${TAILSCALE_HOSTNAME:-social-tracker}
      # Development mode
      - NODE_ENV=development
    volumes:
      # Mount source code for hot reloading in development
      - ./webapp:/app
      # Exclude node_modules to avoid host/container conflicts
      - /app/node_modules
      # Exclude .next build directory
      - /app/.next
      # Persist Tailscale state to avoid re-auth on restart
      - tailscale_data:/var/lib/tailscale
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    depends_on:
      db:
        condition: service_healthy

  ralph:
    build:
      context: .
      dockerfile: Dockerfile.ralph
    container_name: {devports:project}-ralph
    stdin_open: true
    tty: true
    volumes:
      # Mount the project (not your whole home directory!)
      - .:/home/ralph/project
      # Mount node_modules as named volume to avoid permission issues
      - webapp_node_modules:/home/ralph/project/webapp/node_modules
    environment:
      # Database (uses docker network, not localhost)
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/social_tracker
      # Claude Code OAuth token (NOT the API key)
      # Create at: claude /settings or via CLI 'claude' first run
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - GROQ_API_KEY=${GROQ_API_KEY}
      # Git config for commits
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-Ralph}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-ralph@localhost}
      - GIT_COMMITTER_NAME=${GIT_COMMITTER_NAME:-Ralph}
      - GIT_COMMITTER_EMAIL=${GIT_COMMITTER_EMAIL:-ralph@localhost}
      # GitHub token for pushing (fine-grained PAT with repo scope only)
      - GITHUB_TOKEN=${GITHUB_TOKEN}
    depends_on:
      db:
        condition: service_healthy
    working_dir: /home/ralph/project
    networks:
      - default

volumes:
  postgres_data:
  webapp_node_modules:
  tailscale_data:
