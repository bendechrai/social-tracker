# AGENTS.md - Operational Guide

This file contains project-specific commands and patterns. Keep it brief and operational.

## Project Structure

```
/social-tracker
├── specs/           # Requirements (read these first)
├── webapp/          # Next.js application
│   ├── app/         # App Router pages and API routes
│   ├── components/  # React components
│   ├── lib/         # Shared utilities, db client, api helpers
│   ├── drizzle/     # Schema and migrations
│   └── __tests__/   # Test files
├── docker-compose.yml
├── Dockerfile.ralph # Sandbox container for Ralph
├── ralph.sh         # Run Ralph in sandbox
└── loop.sh          # The actual loop (runs inside container)
```

## Running in Sandbox

Ralph runs inside a Docker container for safety. Never run loop.sh directly on host.

```bash
# Start database
docker compose up -d db

# Run Ralph (sandboxed)
./ralph.sh plan      # Generate implementation plan
./ralph.sh           # Build indefinitely
./ralph.sh 20        # Build max 20 iterations
```

## Manual Development (on host)

For manual development outside Ralph:

```bash
# Install dependencies
cd webapp && npm install

# Run migrations
npm run db:migrate

# Seed database
npm run db:seed

# Start dev server
npm run dev
```

App runs at http://localhost:3000 (or devports-assigned port).

## Validation Commands

Run these after implementing to get immediate feedback:

```bash
cd webapp

# Type checking (MUST pass)
npm run typecheck

# Linting (MUST pass)  
npm run lint

# Unit/integration tests
npm run test

# E2E tests (requires dev server running)
npm run test:e2e

# Build (MUST pass before commit)
npm run build
```

## Database Commands

```bash
cd webapp

# Generate migration from schema changes
npm run db:generate

# Apply migrations
npm run db:migrate

# Push schema directly (dev only)
npm run db:push

# Open Drizzle Studio
npm run db:studio
```

## Environment Notes

- Inside Ralph container: DATABASE_URL uses `db:5432` (docker network)
- On host: DATABASE_URL uses `localhost:{devports_port}` 
- The .env file is generated by devports for host usage
- Ralph container gets env vars from docker-compose
- **Reddit credentials are optional for development** - app works without them, tests use MSW mocks
- **Claude Code uses CLAUDE_CODE_OAUTH_TOKEN** (not ANTHROPIC_API_KEY)

## Test Patterns

- Unit tests: `*.test.ts` next to source files or in `__tests__/`
- E2E tests: `e2e/*.spec.ts`
- Test database: Use transaction rollback pattern or test-specific database
- Mocking: MSW for Reddit API, in-memory for simple cases

## Code Patterns

- **Use npm, not pnpm or yarn** - keeps dependency management simple
- Server Actions for mutations (not API routes where possible)
- React Query for client-side data fetching
- Drizzle for database operations (never raw SQL)
- Zod for validation
- shadcn/ui components (install as needed via `npx shadcn@latest add <component>`)

## Common Issues

### Docker volume permissions for node_modules

The `webapp_node_modules` Docker volume is created with root ownership, preventing npm install from working inside the Ralph container.

**To fix this, run from the HOST machine:**
```bash
docker compose down
docker volume rm social-tracker_webapp_node_modules
docker compose up -d db
./ralph.sh  # Volume will be recreated with correct permissions
```

(Updated as issues are discovered during development)

---

*This file is updated by Ralph when operational learnings occur. Keep it focused on HOW to build/run/test.*
